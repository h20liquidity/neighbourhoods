
import {   hexlify } from "ethers/lib/utils";

import { ExpressionConfig, rlc } from "rainlang";

import { MAGIC_NUMBERS, decodeRainMetaDocument } from "../meta/cbor";



/**
 * @public
 * Builds sources and constants from a rainlang expression.
 *
 * @param expressionString - rainlang expression
 * @returns sources and constants
 */
export const standardEvaluableConfig = async (
  expression: string
): Promise<ExpressionConfig> => {
  const rainDocumentEncoded = "0xff0a89c674ee7874a400591149789ced5deb8fdb3612ffdebf825804b86ccfdaacbd4dbbd76f7ddc23b83629d25c0f87b407d0126d132b898e2879d73df47fbf9921f51665f9b52ff843b2bb12250e7ff39be1901c521f3f63ec7ff08fb1b39847e2ec6b7616085f05c29bbcfef26c64ee0442fb78e77bbac338d3a1f40553333695a9662a4bf177cee011bcc2563ccc047bc9e375ba90f19ca998a50bc174cafd9bf38bfcad6a29121e07f0e28f742117a4260c3c93a4f6899a2cdf423d320ec41d4b15a3522c113cc0ea66898a2eaacfa09458cdf5888d5fff66afff3172d71a8a789e2ebaaa7d9b455391144d87bab156aad248d159f1e5887d55d44b3f7fb320c8789951995c8ab3254f408a5424ba824c55ca2a3a2a4b7c7156dcfac3fe66eafa23073a4b6d25637b8587926b41159c912e49dbf8143dd32084885d84f82bdd615a4582a54916fb3c1581418610194809502400c9592c6eeb0f9cb87244ae8cfacb83807391eec72d5f2dd7de0082dd2d4364d8d5a449b09f50573c661930049961684474b9665a202b52c1c66cba861f5afe2e4c09dd419ccb83a048af1f0eca750728b6b5d8d8a2e94e68fc05977128e31b6f99008c4d7c3ef01ba1d9df04581db492fd9cf2507c3383a6581c0ab2f937540034aac9f0becbdfcbde25dc0f05bde34f9a512d54d43c846513a1b3306553684180865bd6722c9467204cc5362a0de64100e268342a14cd884bc507135ba3f81eafc8dfa823c88055121a8a9548746d0b9edaaa6e6518b229d14c06fb198751a853f12a4ec55dda54f89b588b04740836614b305f804864128547057b283c9cafc22c8a49a589ba3584c8f5b58d7735efd9cb5542fd3b7abccb36a2fdb879465c6fc1f5a289e1cf08913103bc4db14bcc449cca4494a8d2f317ec5f5accb290cd54c274cc977aa1d21461453c438e96e62f847f439758283585421928090c56ad640026e374493ba17d5943fb507095aa69536d28d3f0a2655b956575ead1537b42914b58d7d57d76a608d770e377603f5361e039ecfc279100e522443f540053c07c0ee0ab15108ec22d23bff1d4f8778e0548a6995e0a5fce24c6626b86d5187ae6ae40db20c8fe6d42237cd3ad0cd205fc5daa2e9967115886c6874ca483fc96a900d1a01cd6b695322dec1daa1a4f86ba1192b28b0f711170999651cc85f0116e2ed7351e52a7d5959b8984245487bd245982a9b793955f5459d953a909d93cd24f57ad4671b62b348529cacc5cb67035d4161a4ac9dfb6958dd05beb3dac5ea2af809b30581083edc72555ad78b5674565b93b56b0a3ee30cad815519b5c55e9e4c88365315aa385f9568225e86cea9505c81ecb784903153080aa38cbed46330755fe60a21bd83d8ca5fb4d2cd7cf1efc763b835db84acf3c32a6964874f21446cc1868e24060163b191b8869366f52f69b6fdf30333037a4b3e14b49c750cdc145a73901173c09308c857e42ab506c45c50847281d6420c1e6d8b7344b547472b975ac72d90115b406512aa42f7ef5f08e1339e5dd2e64d81a36bd37b64cf77247cd4a6a1b1f90825388f3790c836b06208726200a246a0e10d60c68f6142c7b83b555aed3e0e63d8fe7f8dc471b71560bf82a8277d120890665c99c796c7cd6afe80d06db78274d99fc195e7a648bde30582c34dd3d542c6ea3ba4a3a0d8f0dbb41717a0cc366f73c0aa01337c93e6090de61838e2ab0755eab8a1fd0848abe31a651b3c6d8136c08dd43b367ad759a693e76a8f59b34ccd8bed724f936775e586ccf28f4d43f3ffbfe994c19fb6695386d0ec5f02211a964dd1d55f298986f888f9d56ca693c95247ccd545235086321681692c6de8ce6ad778e2087519384b373d39d1631d420d2f5b29392783daf0c2b1935a1c0a9954ae39aa4d93e80e89a6da3e6b994d8354bf40f9c1a7a092186040fbf6637c2f7f9cde4f597e77612ba121e94eeac39697aa0b1314d63b83b6850d1e435f4d0db1be4570f6c90aea91191f8de78fcfab537e5218fc1cdaa59533f7f1729016d4bd859bcbfbeff0e9f0342a376cc35eefb0a22b72d0deb3033d924876767ad87cf515b91b758ada17af69d926ec2ee8e34dafa815f53bf65450d2de94e35e1e42a3d6def9bc61b4f684ac8e0a07e714f3b7347c22f6d287cce5eb149773cdc1ffb357aa3a1c6db1483a2e7cfd9e47cf7107a4fe61e20f62e38bdb3a371701b983688e193cb5dfccfe4f2f9799f1d7d4909e0269c5395f2d0d3d97219b6e2a81c6973b703e8c704edee48d9c66f002a5f84aa7a5ede5a3e2820b3a5b7652962f0f0581eba932cb03b443fd9a18bc1baabb27d88f69e04f31f0afc0176f3fa6a7ce5a9dbb8cc58a8ad05136674bb84181f61d8ad42cd314d9ba609f7d3a32596e415ece0527a1afed564bc4b17068f9dfa304bb50a84bd1cc372c4a11ea01b1c7b06301f6edc51e0d79387a8b3a43d972f3e65b8f24193272ff57931e596dae5b729e5268a119317e282cd217ac4ac8d740180ff2e123582a1fa8aa09eb1589d46ec1bd4d7b5389318153815370d957fe399a949579609258f64492280ff543e5f8fd99afec3e6836c5d1ed5b541729ace4e79b4ec16be43f6e289c1e2b7a56d35a82a7e8cf93aac6805d6d7fcdb48ec6a19587a6b49318051769485a95c8679222518d05c80f8c905fbc55cf0c16ec0a484c4ab2c10be8c78887378d0523117c9884db3142d897116499a669caa74b15dfad3ce863579b286d5999b9d45a85540d6237d51723ee23dbece2fe03d5bacbc87179c6ba272d5caeb9798a856d1bd5565ce010df68debcb3c0cd7273deea0475412e2de9300ddead6b8d43d2ae19a2dd52d8ed2c0be04f7174ca13d8e98b8985fb03bf65fb6867fbf9fb4b5a3b6005ca7b6227ed71a468850f8b61783db32ca22544cc3999e7ce80369933456759078c1a95ed95adfaea957c627f53e32f5cab8a15ee9cea68a542bf0f98e877e86c9dc1a1399b250d5945bf7bc2725edaa24e55e7f05ac9b3af9d1c02f41276f4f2a38900a0066970a74366d79bd6c4a5352a88193877b50cd9176ea11fed4ad4a1f37388dafdb3325740754329377228000125e5d497b7c9b2b92f2e6c7d7e59fb7a06581764849ff34936514b89d42f3f77565897c9fd765a76f4c92c55460725862040f3af74bd633d4db64c0ecc52fafaeaf4a3a8cdc126a9ee2e6afce3c963733366628088a942dcd56b0fc0106ff2df26925dc6d300bd52d5b729d167b1721e6e86c0026d86c907f90ec89cae2c0cb961b650fd46d6ca4a747b02d55e9e9b68a1910d8971a731b43a5b56bafeae560d13758e1117761ba66c87343f182355c92fe510ca69227544c036db9aff944caa740ca7ceeadf072253f47f748e7d6e0a560718c147df7ee47dd4567ccb6a5626fb723a7d926eef5b9f60f0bcc96c362357b31d5a5eae4d54f065431835a1455a5904dbb2c89c3deee6f333c6ea59b5457246632d118c7c61e2e15591170b10e602ea214ca94a05dc01a179152f2fde24e6acc6d8dc58889500bbba0a769cda9b12a700a8b77088b7b72b205872188275bcbb02621fbcabdc78f94687568754fe9d1d08d171ca09ce90a45b4c04d20b65c4dad0dc5e3f5abc4943c621641df76950fb4433bdfb202b20a24307ac6c17d15383f8d9b1ea111a299e6d76dad26b57d66b787e79557207d855c182ec18ccbf0401250ed33e88ff63c4307a8e6e4e2a78c875eaa5a734e2a02c5dacd7b21f62813cbcbc6fab5597eabe40468b29d57e3ca1619dbb835e3e879b24f3c6c708fdaf8eaf258b423a8c75b063c933d73063eb931879e7a805b1fe4cd69d73da11b11ba39694f5ebd72eb705e1d7172a9d5a66e7818cf74bb766b47dd67df98fdd915d329adace6f1ed1943ba9e2a5271f5a600bed29a954d1d39eea143f76c5ef3d4a907a9c9025a1ead1a0195289265b8bc574d0598eba41fc071ede9fbb5677a9011bc56b9510b05749cf7455dacec10bcedc94a79444caeedd9736b60994c3dbe6aeda4afacfe20583c91e902da237dc6a11f815012fdbf391f653dc285f772a2a73a901e9971573e143b9a33b81b8ede7a3f6657724d56ee3df688aa2f646b01e73f5284810d91e12dc0c894dd2e148cdcbaf1cb27226a5e57258c02280ce3eeee05d2bd70221cfa80ea49be496f553f32fa82bd4786e1e4c92d4f02e35a9f15cffa726410be8e3c9986f5c6347313c2f07b0943ef38b5b6eb32dac74f296cf206485aa726363099ca9827eb062499ceb7dddbdb335ceac371113471a182278ed9a417b459a8542b13b5e2b08c0f1ae8b0cabef689792b83422f4ec0891e98c49d8f6d9f8a3586171486e02b9fbccd51b3fb7099471b4c6e2e14489d400c11091e0f0b204c7efa8b17fa5392bebc639fb3f5f98b17cf39aa98bb9354116419b7faca0aca63f68add0d0bc74c77797fbde55ea060abfb50095be307470f18aab909659fbc3986ee642e4244cdc7971b40f15514d192c7b3c1841abd01968181c1b342a5bfe3ef4f34db1c8297db219e9323eecb0b43d496edc3616d7afa5d7ebc1c25a3237fd60fcc9ffbc2ac2f41dc629639417b69d6e2dd443bafe3ba662fb358cb798c27ba720d6185cdb33bafc4f1331ea94c331ece95b1e65fcff2905f9af3aca76ba6213e4de0895fcf9e9b36a0e7ec9ffac1b86a8343247404440eca8c921ed974cf5e1051f39d298326e1015ae3756c0ccb974eb4497b27a48a13869d8ba97286c9062b91e0512e668f65313b6c8f949f2bdcca32552bda35517cfba172b8d969f1640b658316f36d611585dadd6178b36f5f58e5898e5e32a74094f79641aec313211e37217a93beab2c69e57f97666ff2c0f34f221c56db534ca9aaae279d14bc9d82fb52c1a54a02914c95baf156636fc501f5e2308386b63fb40e82289e65f4e0b17ab852c4fcf4811a5855f91a5fff78f32e7ff497c9f0a0c31cd2b06d5deff2a31bcce226e231b8c6fad90a436bfc804f6db35486caddf724860645aadaa9df722f0e6312ea6ae22522e23246d762cf8888571089761d93490ec11666c9877fbec5f5cb9939b99a8e6fd0789efb91d867e43dc8394ef42677b3072006fe76d56998f6567eea4f8d494f0012d3ae8d00d04fccecca74775f94773150c07c71ee67cc04cd8fcee9f834893d7f184fc3cbadabde553d150c2d2a1b212482743208eceaa911c73466409bf1342dcb32f8e90bb912ad410c65a1634986e364b30c56332b8c52cca3c41c6408ef3a28ffb162d50982133c88c7e46c8d51813d75c852cce3f9692275f8dee3a7eb6c2e4ad30ccb938b0ae332af67abb1cb3aef2fe7c436155bbae3215243d554eb480dbe1bec762e5a531206687623d6af4cc2ce92cba43832d940a9a143c1c414e0a9f9ca543e07748339a0b57388ab49f507273154d71dcee4b2d850a6de9803ec7469c3f6ef0446226ddc3a4f69bea5b2c4c726a4c7446a8b506eabacb4aef381a8896eeb4f2584c014722c557b56ac9a2a6b4a34cc9cfa5e7c47891fe2aa963846c45362f2cf51e14e38e92f2873b66b23dc831ce33bf96dc43e5ee17fe3cbcd9fb5701ce3bbe3c9bcf6b3169342eced5c19e9edf80765d63f4a666f3636116001cc7530198bc71ae052832d4b07b299ba2f6fa6120faff771bb9cc5202e876225c2e74878e2fa1744f8f166c25f1d83f0577b101e347b0f07a823579eb68134883f60d22f90b3d626a99a81144519161589b0b343136b26dddb9b9b03310a1b710ad03d153815ee69c0a79b448fd37384b1531774b09017a6ad78bbde07e733eda67c1eed95996745da59e9d25c5fa988143c5dee61cff508a1247e6a728e69cfa02efca0d73ebe8aded4b567d5b480418b4d6d5f33daad83b9733c5eb3d673c57edaab111b97df9c19b9ab767dadac523316f91a4f721ad132037e8505f3e7bbeabd1eb1bff46f869d0cdac7fb748e0a4d04183a597aebe0cb06a234a42e4ebac4689af64fa67419e895738bcf399e293edcf66a616947a5b68f46be93527f009d22c70fe2641da69a2d039e5a480a27eb25a4a741b64b2f28be7585cf990f4cdb43fc78d1aaa6c99269b6ccf920218588836a94546b056578da0c3a694e0830187491f88b7e12031baf876dd5c70fd3f68a44258609b5f9bb76d747d9c85ea58adb7ad2a6f598c7ace9103f5275189b496b3663ebc1c0acac6bbf8eae6831e23362d5bfad89500ff8d96f9ffd1ff9cdc38f011bffe5282f43e495b402706170706c69636174696f6e2f6a736f6e03676465666c617465";

  const dataDecoded = decodeRainMetaDocument(rainDocumentEncoded);

  // Find the correct element related to OPS_META_V1
  const opsMetaMap = dataDecoded.find(
    (elem_) => elem_.get(1) === MAGIC_NUMBERS.OPS_META_V1
  );

  const hexOpsMeta = hexlify(opsMetaMap.get(0));

  return await rlc(expression, hexOpsMeta)
    .then((expressionConfig) => {
      return expressionConfig;
    })
    .catch((error) => {
      throw new Error(JSON.stringify(error, null, 2));
    });
};
